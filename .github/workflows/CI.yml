# ============================================================================
# Continuous Integration Workflow
# Unifica:
#  - Python Format (Black + isort)
#  - Pytest con MariaDB
#  - Test Coverage
# ============================================================================

name: CI Pipeline

on:
  push:
    branches: [ "trunk", "feat-**", "main" ]
  pull_request:
    branches: [ "trunk", "main" ]

# Needed so CI can emit repository_dispatch to trigger CD
permissions:
  contents: write
  actions: write

jobs:
  # --------------------------------------------------------------------------
  # 1) Linting (Black & isort)
  # --------------------------------------------------------------------------
  lint:
    name: Lint (Black & isort)
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install Black & isort
        run: |
          python -m pip install --upgrade pip
          pip install black isort

      - name: Run Black
        run: black . --line-length 120

      - name: Run isort
        run: isort .

  # --------------------------------------------------------------------------
  # 2) Tests (pytest)
  # --------------------------------------------------------------------------
  pytest:
    name: Run Tests
    runs-on: ubuntu-24.04
    needs: lint
    env:
      MARIADB_ROOT_PASSWORD: uvlhub_root_password
      MARIADB_DATABASE: uvlhubdb_test
      MARIADB_TEST_DATABASE: uvlhubdb_test
      MARIADB_USER: uvlhub_user
      MARIADB_PASSWORD: uvlhub_password
      MARIADB_HOSTNAME: 127.0.0.1
      MARIADB_PORT: 3306
      FLASK_ENV: testing
      SELENIUM_HOST: http://127.0.0.1:5000   # <--- Para tus tests Selenium
    services:
      mariadb:
        image: mariadb:12.0.2
        env:
          MARIADB_ROOT_PASSWORD: ${{ env.MARIADB_ROOT_PASSWORD }}
          MARIADB_DATABASE: ${{ env.MARIADB_DATABASE }}
          MARIADB_USER: ${{ env.MARIADB_USER }}
          MARIADB_PASSWORD: ${{ env.MARIADB_PASSWORD }}
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mariadb-admin ping -u root -p$MARIADB_ROOT_PASSWORD"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Delete rosemary editable mode
        run: sed -i '/rosemary @ file:\/\/\/app/d' requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Start Flask in background and wait for readiness
        run: |
          export FLASK_APP=app
          flask run --host=0.0.0.0 --port=5000 &
          for i in {1..20}; do
            curl -s http://127.0.0.1:5000/ >/dev/null && break
            echo "Waiting for Flask to be ready... ($i)"
            sleep 1
          done

      - name: Run pytest
        run: pytest app/modules/ --ignore-glob='*selenium*'

  # --------------------------------------------------------------------------
  # 3) Test Coverage
  # --------------------------------------------------------------------------
  coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    needs: pytest
    env:
      FLASK_ENV: testing
      WORKING_DIR: ""  # fuerza modo local en initialize_driver
      MARIADB_ROOT_PASSWORD: uvlhub_root_password
      MARIADB_DATABASE: uvlhubdb_test
      MARIADB_TEST_DATABASE: uvlhubdb_test
      MARIADB_USER: uvlhub_user
      MARIADB_PASSWORD: uvlhub_password
      MARIADB_HOSTNAME: 127.0.0.1
      MARIADB_PORT: 3306
    services:
      mariadb:
        image: mariadb:12.0.2
        env:
          MARIADB_ROOT_PASSWORD: ${{ env.MARIADB_ROOT_PASSWORD }}
          MARIADB_DATABASE: ${{ env.MARIADB_DATABASE }}
          MARIADB_USER: ${{ env.MARIADB_USER }}
          MARIADB_PASSWORD: ${{ env.MARIADB_PASSWORD }}
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mariadb-admin ping -u root -p$MARIADB_ROOT_PASSWORD"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Delete rosemary editable mode
        run: sed -i '/rosemary @ file:\/\/\/app/d' requirements.txt

      - name: Install dependencies and pytest-cov
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-cov

      - name: Wait for MariaDB to be ready
        run: |
          for i in {1..30}; do
            if (echo > /dev/tcp/127.0.0.1/3306) >/dev/null 2>&1; then
              echo "MariaDB is listening"
              break
            fi
            echo "Waiting for MariaDB... ($i)"
            sleep 1
          done

      - name: Run tests with coverage (exclude selenium)
        run: |
          # Exclude Selenium tests here: they are run in a separate job that
          # starts the server and webdriver. This avoids trying to run
          # browser tests when no server/driver is available.
          pytest --ignore-glob='*selenium*' --cov=app --cov-report=term-missing --cov-report=xml

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

  # --------------------------------------------------------------------------
  # 4) Dispatch CD for trunk after CI success
  # --------------------------------------------------------------------------
  dispatch_predeploy_trunk:
    name: Dispatch CD PreDeploy (trunk)
    runs-on: ubuntu-24.04
    needs: coverage
    if: ${{ github.ref == 'refs/heads/trunk' }}
    steps:
      - name: Debug context
        uses: actions/github-script@v7
        with:
          script: |
            core.info(`Ref: ${context.ref}`)
            core.info(`SHA: ${context.sha}`)
      - name: Create repository_dispatch event (predeploy)
        uses: actions/github-script@v7
        with:
          script: |
            await github.request('POST /repos/{owner}/{repo}/dispatches', {
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'predeploy',
              client_payload: {
                branch: context.ref.replace('refs/heads/', ''),
                sha: context.sha
              }
            });

